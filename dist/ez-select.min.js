"use strict";angular.module("ez.select",["ez.object2array"]).constant("ezSelectConfig",{method:"GET",idField:"id",textField:"text",placeholder:"Select an option",multiple:!1,multiPlaceholder:"Click to select an option",searchPlaceholder:"Search...",searchHelpText:"Enter $$ or more characters...",minSearchChars:2,url:"",emptyText:"No options found"}).directive("ezSelect",["ezSelectConfig","$document","$timeout","$q","$http","object2arrayFilter","filterFilter","orderByFilter",function(ezSelectConfig,$document,$timeout,$q,$http,object2arrayFilter,filterFilter,orderByFilter){return{restrict:"EA",replace:!0,scope:{options:"=?options",selected:"=?selected",config:"=?config"},templateUrl:"ez-select-tpl.html",compile:function(element,attrs){var $toggle=element.find(".ez-select-toggle"),maxChars=$toggle.width()/(.5*parseFloat($toggle.css("font-size"),10)),config=angular.extend({},ezSelectConfig);return angular.forEach(Object.keys(ezSelectConfig),function(key){"undefined"!=typeof attrs[key]&&(config[key]=attrs[key])}),function(scope,element){scope.config=angular.extend(config,scope.config),scope.showDropdown=!1,scope.emptyText=config.emptyText,scope.query="",scope.form={query:""},"undefined"==typeof scope.options&&(scope.options=[]),"undefined"==typeof scope.selected&&(scope.selected=scope.config.multiple?[]:""),scope.config.url?(scope.ajaxSearch=!0,scope.showSearchInput=!0):(scope.ajaxSearch=!1,scope.showSearchInput=!!scope.config.search),scope.filter=function(){scope._options=object2arrayFilter(scope.options),scope._options=orderByFilter(scope._options,["-_selected",scope.config.textField]),scope.query&&(scope._options=filterFilter(scope._options,{text:scope.query})),scope.emptyText=scope.ajaxSearch?scope.form.query.length<scope.config.minSearchChars?scope.config.searchHelpText.replace("$$",parseInt(scope.config.minSearchChars,10)-scope.form.query.length):scope._options.length?!1:scope.config.emptyText:scope._options.length?!1:scope.config.emptyText},scope.closeDropdown=function(e){if("undefined"!=typeof e){if($(e.target).parents(".ez-select-container").get(0)===element.get(0))return!1;scope.showDropdown=!1,scope.$apply()}else scope.showDropdown=!1;$document.unbind("click",scope.closeDropdown)},scope.open=function(e){scope.showDropdown?scope.closeDropdown(e):(scope.showDropdown=!0,$document.click(scope.closeDropdown))},scope.select=function(e,option){if(e.preventDefault(),e.stopPropagation(),option._selected)if(scope.$emit("ez_select.unselect",option),scope.config.multiple){var i=scope.selected.indexOf(option[scope.config.idField]);-1!==i&&scope.selected.splice(i,1)}else scope.selected="";else scope.$emit("ez_select.select",option),scope.config.multiple?scope.selected.push(option[scope.config.idField]):scope.selected=option[scope.config.idField];scope.config.multiple||scope.closeDropdown()},scope.updateText=function(){var str="";scope.config.multiple?(angular.forEach(scope.selected,function(selectedOption){angular.forEach(scope.options,function(option){selectedOption[scope.config.idField]===option[scope.config.idField]&&(str+=option[scope.config.textField]+", ")})}),str=str.slice(0,-2)):angular.forEach(scope.options,function(option){option[scope.config.idField]===scope.selected&&(str+=option[scope.config.textField])}),str?str.length>maxChars&&(str=scope.config.multiple?scope.selected.length+" selected":"1 selected"):str=scope.config.placeholder,scope.selectedText=str};var req,canceler=$q.defer();scope.$watch("form.query",function(newVal,oldVal){scope.ajaxSearch?newVal&&newVal!==oldVal&&newVal.length>=scope.config.minSearchChars?(req===!0&&(canceler.resolve(),canceler=$q.defer()),req=!0,$http({method:scope.config.method,url:scope.config.url,params:{q:newVal},timeout:canceler.promise}).success(function(data){req=!1,scope.options=data,scope.filter()}).error(function(e){scope.$broadcast("ez-select.error.search",e)})):(scope.options={},scope.filter()):(scope.query=newVal,scope.filter())}),scope.$watchCollection("selected",function(newVal){scope.config.multiple?angular.forEach(scope.options,function(v){v._selected=-1!==newVal.indexOf(v[scope.config.idField])?!0:!1}):angular.forEach(scope.options,function(v){v._selected=newVal===v[scope.config.idField]?!0:!1}),scope.updateText(),scope.filter()})}}}}]);