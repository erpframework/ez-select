"use strict";angular.module("ez.select",[]).constant("ezSelectConfig",{textField:"text",idField:"id"}).directive("ezSelect",["ezSelectConfig","$document","filterFilter","orderByFilter",function(ezSelectConfig,$document,filterFilter,orderByFilter){return{restrict:"EA",replace:!0,scope:{options:"=options",selectedOptionIds:"=selectedOptionIds",search:"=search"},templateUrl:"ez-select.tpl.html",compile:function(element,attrs){var $toggle=element.find(".ez-select-toggle"),fontSize=parseFloat($toggle.css("font-size"),10),maxChars=$toggle.width()/(.5*fontSize),multiple=!!attrs.multiple;return function(scope,element){scope._options=[],scope.selectedOptions=[],scope.multiple=multiple;var closeDropdown=function(e){$(e.target).parents(".ez-select").get(0)||($document.unbind("click",closeDropdown),element.removeClass("open"))};scope.open=function(){element.addClass("open"),element.find(".search-box input").trigger("focus"),$document.click(closeDropdown)},scope.select=function(option){if(option._selected){var i=scope.selectedOptionIds.indexOf(option.id);-1!==i&&(scope.selectedOptionIds.splice(i,1),scope.selectedOptions.splice(i,1))}else scope.selectedOptionIds.push(option.id),scope.selectedOptions.push(option);scope.filter(),scope.updateText()},scope.updateText=function(){var str="",count=0;angular.forEach(scope.options,function(option){-1!==scope.selectedOptionIds.indexOf(option.id)?(option._selected=!0,str+=option[ezSelectConfig.textField]+", ",count++):option._selected=!1}),str=str?str.length>maxChars?count+" selected":str.slice(0,-2):"Select an option",scope.selectedText=str},scope.filter=function(query){scope._options=query?filterFilter(scope.options,query):scope.options,scope._options=orderByFilter(orderByFilter(scope._options,ezSelectConfig.textField,!0),"_selected",!0)},scope.$watch("form.query",function(newVal,oldVal){scope.search&&newVal&&newVal.length>0&&newVal!==oldVal?scope.search(newVal).then(function(data){angular.forEach(data,function(option){-1===scope.options.indexOf(option)&&(option._selected=!1,scope.options.push(option))}),scope.filter(newVal)}):scope.filter(newVal)}),scope.updateText(),angular.forEach(scope.options,function(option){-1!==scope.selectedOptionIds.indexOf(option.id)&&scope.selectedOptions.push(option)})}}}}]);