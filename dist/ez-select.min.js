"use strict";angular.module("ez.select",[]).constant("ezSelectConfig",{textField:"text",idField:"id"}).directive("ezSelect",["ezSelectConfig","$document","filterFilter","orderByFilter",function(ezSelectConfig,$document,filterFilter,orderByFilter){return{restrict:"EA",replace:!0,scope:{options:"=options",selected:"=selected",search:"=search"},templateUrl:"ez-select.tpl.html",compile:function(element,attrs){var $toggle=element.find(".ez-select-toggle"),fontSize=parseFloat($toggle.css("font-size"),10),maxChars=$toggle.width()/(.5*fontSize),multiple=!!attrs.multiple,closeDropdown=function(){$document.unbind("click",closeDropdown),element.removeClass("open")};return function(scope,element){scope._options=[],scope.selectedOptions=[],scope.multiple=multiple,scope.open=function(e){e.preventDefault(),e.stopPropagation(),element.addClass("open"),element.find(".search-box input").trigger("focus"),$document.click(closeDropdown)},scope.select=function(e,option){e.preventDefault(),e.stopPropagation(),multiple?option._selected?scope.selected.splice(scope.selected.indexOf(option.id),1):scope.selected.push(option.id):(scope.selected=option.id,closeDropdown())},scope.updateText=function(){var str="",count=0;angular.forEach(scope.options,function(option){-1!==scope.selected.indexOf(option.id)&&(str+=option[ezSelectConfig.textField]+", ",count++)}),str=str?str.length>maxChars?count+" selected":str.slice(0,-2):"Select an option",scope.selectedText=str},scope.filter=function(query){scope._options=query?filterFilter(scope.options,query):scope.options,scope._options=orderByFilter(orderByFilter(scope._options,ezSelectConfig.textField,!0),"_selected",!0)},scope.$watch("form.query",function(newVal,oldVal){scope.search&&newVal&&newVal.length>0&&newVal!==oldVal?scope.search(newVal).then(function(data){angular.forEach(data,function(option){-1===scope.options.indexOf(option)&&(option._selected=!1,scope.options.push(option))}),scope.filter(newVal)}):scope.filter(newVal)}),scope.$watchCollection("selected",function(){angular.forEach(scope.options,function(option){if(multiple)if(-1!==scope.selected.indexOf(option.id))-1===scope.selectedOptions.indexOf(option)&&scope.selectedOptions.push(option),option._selected=!0;else{var index=scope.selectedOptions.indexOf(option);-1!==index&&scope.selectedOptions.splice(index,1),option._selected=!1}else scope.selected===option.id?(console.log("match!"),scope.selectedOptions=[option],option._selected=!0):option._selected=!1,scope.updateText()})})}}}}]);